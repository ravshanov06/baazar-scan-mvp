
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BazaarScan - Vendor App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f5;
            padding-bottom: 80px;
        }

        .header { 
            background: #27ae60; 
            color: white; 
            padding: 20px; 
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-weight: bold;
            color: #666;
        }

        .step.active { background: #27ae60; color: white; }
        .step.completed { background: #2ecc71; color: white; }

        .form-group { margin-bottom: 20px; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #333;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #27ae60;
        }

        #map { 
            height: 300px; 
            border-radius: 8px; 
            margin-bottom: 10px;
            border: 2px solid #ddd;
        }

        .location-hint {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }

        .btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            font-weight: 600;
            transition: background 0.3s;
        }
        .btn:hover { background: #229954; }
        .btn:disabled { background: #95a5a6; cursor: not-allowed; }

        .product-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }

        .product-row input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .product-row input[type="number"] { max-width: 100px; }
        .product-row select { max-width: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .product-row button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 4px;
            cursor: pointer;
        }

        .add-product-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            font-size: 16px;
        }

        .message { 
            padding: 16px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            text-align: center;
        }
        .message.success { background: #d5f4e6; color: #27ae60; }
        .message.error { background: #fadbd8; color: #c0392b; }

        .hidden { display: none; }

        .success-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .success-screen h2 { color: #27ae60; margin-bottom: 20px; }
        .success-screen p { color: #666; margin-bottom: 30px; }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .bottom-nav a {
            color: #666;
            text-decoration: none;
            text-align: center;
            font-size: 12px;
        }

        .bottom-nav a.active { color: #27ae60; }
    </style>
<base target="_blank">
</head>
<body>
    <div class="header">
        <h1>üõí Vendor Portal</h1>
        <p>Register your store & update prices</p>
    </div>

    <div class="container">
        <!-- Step 1: Location -->
        <div id="step1" class="step-content">
            <div class="step-indicator">
                <div class="step active">1</div>
                <div class="step">2</div>
                <div class="step">3</div>
            </div>

            <div class="card">
                <h2>üìç Set Your Location</h2>
                <p style="color: #666; margin-bottom: 20px;">Tap on the map to place your store marker</p>

                <div id="map"></div>
                <p class="location-hint">Or enter address manually below</p>

                <div class="form-group" style="margin-top: 15px;">
                    <label>Store Address</label>
                    <textarea id="store-address" rows="2" placeholder="Enter full address..."></textarea>
                </div>

                <button class="btn" onclick="confirmLocation()">Confirm Location ‚Üí</button>
            </div>
        </div>

        <!-- Step 2: Store Details -->
        <div id="step2" class="step-content hidden">
            <div class="step-indicator">
                <div class="step completed">‚úì</div>
                <div class="step active">2</div>
                <div class="step">3</div>
            </div>

            <div class="card">
                <h2>üè™ Store Details</h2>
                <div id="details-message"></div>

                <form id="store-form" onsubmit="registerStore(event)">
                    <div class="form-group">
                        <label>Store Name</label>
                        <input type="text" id="store-name" placeholder="Ali's Vegetable Shop" required>
                    </div>

                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="store-phone" placeholder="+998901234567" required>
                    </div>

                    <div class="form-group">
                        <label>Category</label>
                        <select id="store-category" required>
                            <option value="">Select category...</option>
                            <option value="vegetables">ü•¨ Vegetables</option>
                            <option value="fruits">üçé Fruits</option>
                            <option value="meat">ü•© Meat</option>
                            <option value="dairy">ü•õ Dairy</option>
                            <option value="grains">üåæ Grains</option>
                            <option value="other">üì¶ Other</option>
                        </select>
                    </div>

                    <button type="submit" class="btn">Register Store ‚Üí</button>
                </form>
            </div>
        </div>

        <!-- Step 3: Add Prices -->
        <div id="step3" class="step-content hidden">
            <div class="step-indicator">
                <div class="step completed">‚úì</div>
                <div class="step completed">‚úì</div>
                <div class="step active">3</div>
            </div>

            <div class="card">
                <h2>üí∞ Today's Prices</h2>
                <div id="price-message"></div>

                <form id="price-form" onsubmit="submitPrices(event)">
                    <input type="hidden" id="price-shop-id">

                    <div id="product-list">
                        <div class="product-row">
                            <input type="text" placeholder="Product name" class="prod-name" required>
                            <input type="number" placeholder="Price" class="prod-price" step="0.01" required>
                            <select class="prod-unit">
                                <option value="kg">/kg</option>
                                <option value="liter">/L</option>
                                <option value="piece">/pc</option>
                            </select>
                            <button type="button" onclick="removeProduct(this)">√ó</button>
                        </div>
                    </div>

                    <button type="button" class="add-product-btn" onclick="addProduct()">+ Add Another Product</button>

                    <button type="submit" class="btn">Submit Prices</button>
                </form>
            </div>
        </div>

        <!-- Success Screen -->
        <div id="success" class="step-content hidden">
            <div class="card success-screen">
                <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
                <h2>All Done!</h2>
                <p>Your store is registered and prices are updated.<br>Customers can now find you on the map.</p>
                <button class="btn" onclick="location.reload()">Add More Prices</button>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="/vendor.html" class="active">üè™<br>Vendor</a>
        <a href="/index.html">üó∫Ô∏è<br>Map</a>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, marker;
        let selectedLat = null, selectedLon = null;
        let registeredShopId = null;

        // Initialize map
        function initMap() {
            // Default to Tashkent
            map = L.map('map').setView([41.2995, 69.2401], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // Try to get user location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const lat = pos.coords.latitude;
                        const lon = pos.coords.longitude;
                        map.setView([lat, lon], 16);
                        placeMarker(lat, lon);
                    },
                    (err) => console.log('GPS error:', err)
                );
            }

            // Click to place marker
            map.on('click', (e) => {
                placeMarker(e.latlng.lat, e.latlng.lng);
            });
        }

        function placeMarker(lat, lon) {
            selectedLat = lat;
            selectedLon = lon;

            if (marker) map.removeLayer(marker);

            marker = L.marker([lat, lon], {
                draggable: true
            }).addTo(map);

            marker.on('dragend', (e) => {
                selectedLat = e.target.getLatLng().lat;
                selectedLon = e.target.getLatLng().lng;
            });

            // Reverse geocode to get address
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('store-address').value = data.display_name;
                })
                .catch(err => console.log('Geocoding error:', err));
        }

        function confirmLocation() {
            if (!selectedLat || !selectedLon) {
                alert('Please tap on the map to select your store location');
                return;
            }

            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }

        async function registerStore(e) {
            e.preventDefault();

            const address = document.getElementById('store-address').value;

            const data = {
                name: document.getElementById('store-name').value,
                phone: document.getElementById('store-phone').value,
                address: address,
                lat: selectedLat,
                lon: selectedLon,
                category: document.getElementById('store-category').value
            };

            try {
                const res = await fetch('/api/shops/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    registeredShopId = result.shop.id;
                    document.getElementById('price-shop-id').value = registeredShopId;

                    document.getElementById('step2').classList.add('hidden');
                    document.getElementById('step3').classList.remove('hidden');
                } else {
                    showMessage('details-message', 'error', result.error);
                }
            } catch (error) {
                showMessage('details-message', 'error', 'Network error: ' + error.message);
            }
        }

        async function submitPrices(e) {
            e.preventDefault();

            const phone = document.getElementById('store-phone').value;
            const products = [];

            document.querySelectorAll('.product-row').forEach(row => {
                products.push({
                    name: row.querySelector('.prod-name').value.toLowerCase(),
                    price: parseFloat(row.querySelector('.prod-price').value),
                    unit: row.querySelector('.prod-unit').value
                });
            });

            try {
                const res = await fetch('/api/shops/submit-prices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone,
                        shopName: document.getElementById('store-name').value,
                        marketId: null,
                        sectionId: null,
                        category: document.getElementById('store-category').value,
                        products
                    })
                });

                const result = await res.json();

                if (result.success) {
                    document.getElementById('step3').classList.add('hidden');
                    document.getElementById('success').classList.remove('hidden');
                } else {
                    showMessage('price-message', 'error', result.error);
                }
            } catch (error) {
                showMessage('price-message', 'error', 'Network error: ' + error.message);
            }
        }

        function addProduct() {
            const div = document.createElement('div');
            div.className = 'product-row';
            div.innerHTML = `
                <input type="text" placeholder="Product name" class="prod-name" required>
                <input type="number" placeholder="Price" class="prod-price" step="0.01" required>
                <select class="prod-unit">
                    <option value="kg">/kg</option>
                    <option value="liter">/L</option>
                    <option value="piece">/pc</option>
                </select>
                <button type="button" onclick="removeProduct(this)">√ó</button>
            `;
            document.getElementById('product-list').appendChild(div);
        }

        function removeProduct(btn) {
            const rows = document.querySelectorAll('.product-row');
            if (rows.length > 1) btn.parentElement.remove();
        }

        function showMessage(elementId, type, text) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => el.innerHTML = '', 5000);
        }

        // Initialize
        initMap();
    </script>
</body>
</html>